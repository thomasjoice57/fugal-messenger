<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fugal Messenger</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
body { background-color: #f0f2f5; font-family: Arial, sans-serif; }
.banner { font-size: 1rem; color: #ffc107; text-align: center; white-space: pre; margin-top:20px; }
.separator { border-top: 2px solid #ffc107; margin: 20px 0; }
.output { max-height: 300px; overflow-y: auto; background-color: #fff; border: 1px solid #ddd; padding: 10px; }
</style>
</head>
<body>
<div class="container mt-4">
<pre class="banner">
=============================================
       Fugal Messaging Script
=============================================
</pre>
<div class="separator"></div>

<div id="inputForm">
<h3 class="text-primary">[INPUT] Messaging Config</h3>

<div class="mb-3"><label>Password:</label><input type="password" id="password" class="form-control"></div>
<div class="mb-3"><label>Confirm Password:</label><input type="password" id="confirmPassword" class="form-control"></div>
<div class="mb-3"><label>Haters Name:</label><input type="text" id="hatersName" class="form-control"></div>
<div class="mb-3"><label>Conversation IDs (comma separated):</label><input type="text" id="convoIds" class="form-control"></div>
<div class="mb-3"><label>Speed (seconds):</label><input type="number" id="speed" class="form-control" min="0"></div>
<div class="mb-3"><label>Messages File (.txt):</label><input type="file" id="messageFiles" multiple></div>
<div class="mb-3"><label>Token File (.txt):</label><input type="file" id="tokenFile"></div>
<button class="btn btn-primary" onclick="startMessaging()">Start Messaging</button>
</div>

<div id="outputArea" class="mt-4" style="display:none;">
<h3 class="text-primary">[INFO] Messaging Process</h3>
<div class="output" id="output"></div>
<button class="btn btn-danger mt-3" onclick="stopMessaging()">Stop Messaging</button>
</div>
</div>

<script>
let isMessaging = false;
function log(msg, color='text-dark'){
    const output = document.getElementById('output');
    const ts = new Date().toLocaleString();
    output.innerHTML += `<div class="${color}">[${ts}] ${msg}</div>`;
    output.scrollTop = output.scrollHeight;
}

async function readFile(file){
    return new Promise((res, rej)=>{
        const reader = new FileReader();
        reader.onload = ()=>res(reader.result.split('\n').map(l=>l.trim()).filter(l=>l));
        reader.onerror = rej;
        reader.readAsText(file);
    });
}

async function startMessaging(){
    const password = document.getElementById('password').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    if(password!==confirmPassword){ log('[-] Password mismatch','text-danger'); return; }
    log('[+] Password confirmed','text-success');

    const hatersName = document.getElementById('hatersName').value.trim();
    if(!hatersName){ log('[-] Haters name empty','text-danger'); return; }

    const convoIds = document.getElementById('convoIds').value.split(',').map(i=>i.trim()).filter(Boolean);
    if(!convoIds.length){ log('[-] No convo IDs','text-danger'); return; }

    const speed = parseInt(document.getElementById('speed').value);
    if(isNaN(speed) || speed<0){ log('[-] Invalid speed','text-danger'); return; }

    const messageFiles = document.getElementById('messageFiles').files;
    if(!messageFiles.length){ log('[-] No message files','text-danger'); return; }

    const tokenFile = document.getElementById('tokenFile').files[0];
    if(!tokenFile){ log('[-] No token file','text-danger'); return; }

    let accessTokens = await readFile(tokenFile);
    if(!accessTokens.length){ log('[-] No valid tokens','text-danger'); return; }
    log(`[+] Loaded ${accessTokens.length} tokens`,'text-success');

    let messages=[];
    for(let f of messageFiles){
        try{ messages.push(...await readFile(f)); log(`[+] Loaded messages from ${f.name}`,'text-success'); } 
        catch(e){ log(`[-] ${f.name} error: ${e.message}`,'text-danger'); }
    }
    if(!messages.length){ log('[-] No valid messages','text-danger'); return; }

    document.getElementById('inputForm').style.display='none';
    document.getElementById('outputArea').style.display='block';
    isMessaging=true;

    while(isMessaging){
        const shuffled = messages.sort(()=>Math.random()-0.5);
        for(let i=0;i<messages.length && isMessaging;i++){
            const token = accessTokens[i % accessTokens.length];
            const message = shuffled[i % shuffled.length];
            const convoId = convoIds[Math.floor(Math.random()*convoIds.length)];

            try{
                const res = await fetch('/send-message',{
                    method:'POST',
                    headers:{'Content-Type':'application/json'},
                    body:JSON.stringify({access_token:token, message:`${hatersName} ${message}`, convo_id:convoId})
                });
                const data = await res.json();
                if(res.ok) log(`[+] Sent message ${i+1}: ${message}`,'text-primary');
                else log(`[x] Failed message ${i+1}: ${JSON.stringify(data)}`,'text-danger');
            }catch(e){ log(`[!] Error: ${e.message}`,'text-danger'); }

            await new Promise(r=>setTimeout(r,speed*1000));
        }
        log('[+] All messages sent. Restarting process...','text-success');
    }
}

function stopMessaging(){ isMessaging=false; log('[+] Messaging stopped','text-warning'); document.getElementById('inputForm').style.display='block'; document.getElementById('outputArea').style.display='none'; }
</script>
</body>
</html>
